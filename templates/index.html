{% extends "base.html" %}

{% block title %}{% endblock %}

{% block description %}Discover the complete collection of Euro coins from 1999 to 2025. Browse 832 coins including 284 regular and 547 commemorative coins from all 27 eurozone countries.{% endblock %}

{% block canonical_path %}/{% endblock %}

{% block main_class %}bg-light{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section bg-primary text-white py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <div class="hero-content">
                    <h1 class="display-4 fw-bold mb-4">
                        My EuroCoins
                    </h1>
                    <p class="lead mb-4">
                        Discover regular circulation and commemorative coins from all eurozone countries.
                    </p>
                    <!-- data source moved to footer -->
                    <a href="{% if group_context %}{% if selected_member %}/{{ group_context.group_key }}/{{ selected_member }}/catalog{% else %}/{{ group_context.group_key }}/catalog{% endif %}{% else %}/catalog{% endif %}" class="btn btn-light btn-lg">
                        <i class="fas fa-search me-2"></i>Browse Catalog
                    </a>
                    
                    <!-- Latest coins rotator (Hero) simplified -->
                    <div class="d-flex justify-content-center mt-4">
                        <div id="hero-latest-coin" class="card hero-coin-card text-white text-center" style="width: 240px;">
                            <div class="card-body py-2 d-flex flex-column align-items-center">
                                <img id="hero-coin-img" src="/static/images/myeurocoins-icon.png" alt="coin" class="hero-coin-img mb-2" style="width:96px;height:96px;object-fit:cover;border-radius:50%;background:#fff;">
                                <div class="d-flex justify-content-between align-items-center w-100 mt-2">
                                    <h6 class="card-title mb-0 text-start">
                                        <span class="country-flag me-2" id="hero-country-flag">ðŸ‡ªðŸ‡º</span>
                                        <span id="hero-country" class="fw-semibold"></span>
                                    </h6>
                                    <span id="hero-value" class="h5 mb-0 text-white fw-bold"></span>
                                </div>
                                <div class="w-100 mt-1">
                                    <p id="hero-type-year" class="card-text text-white-50 small mb-0"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Carousel indicator dots (3) -->
                    <div class="d-flex justify-content-center mt-2">
                        <div id="hero-dots" class="d-flex gap-2" aria-hidden="false">
                            <span class="hero-dot"></span>
                            <span class="hero-dot"></span>
                            <span class="hero-dot"></span>
                            <span class="hero-dot"></span>
                        </div>
                    </div>
                                    <!-- Compact stats inside hero -->
                                    <div class="d-flex justify-content-center align-items-center mt-4 gap-3 flex-wrap">
                                        <div class="text-center text-white-75 small">
                                            <div class="fw-bold fs-5">{{ stats.total_coins or 0 }}</div>
                                            <div class="text-white-50">Coins</div>
                                        </div>
                                        <div class="text-center text-white-75 small">
                                            <div class="fw-bold fs-5">{{ stats.total_countries or 0 }}</div>
                                            <div class="text-white-50">Countries</div>
                                        </div>
                                        <div class="text-center text-white-75 small">
                                            <div class="fw-bold fs-5">{{ stats.regular_coins or 0 }}</div>
                                            <div class="text-white-50">Regular</div>
                                        </div>
                                        <div class="text-center text-white-75 small">
                                            <div class="fw-bold fs-5">{{ stats.commemorative_coins or 0 }}</div>
                                            <div class="text-white-50">Commemorative</div>
                                        </div>
                                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Member Statistics Section (only in group mode) -->
{% if group_mode and member_stats %}
<section class="member-stats-section py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h2 class="text-center mb-4">Group Member Statistics</h2>
                <div class="row g-3">
                    {% for member in member_stats %}
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <div class="card h-100 member-stat-card{% if selected_member and selected_member == member.name %} border-primary{% endif %}">
                            <div class="card-body text-center">
                                <h5 class="card-title">{{ member.alias or member.name }}</h5>
                                <div class="member-stats">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ member.owned_coins_count or 0 }}</div>
                                        <div class="stat-label">Coins Owned</div>
                                    </div>
                                    {% if member.last_added_date %}
                                    <div class="stat-item mt-2">
                                        <div class="stat-label small text-muted">Last Added</div>
                                        <div class="stat-date">{{ member.last_added_date.strftime('%b %d, %Y') if member.last_added_date else 'N/A' }}</div>
                                        {% if member.last_coin_description %}
                                        <div class="stat-coin small text-muted mt-1">{{ member.last_coin_description }}</div>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="stat-item mt-2">
                                        <div class="stat-label small text-muted">No coins added yet</div>
                                    </div>
                                    {% endif %}
                                </div>
                                <a href="/{{ group_context.group_key }}/{{ member.name }}/catalog" class="btn btn-outline-primary btn-sm mt-2">
                                    View Collection
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Add some simple animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate stats on scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate__fadeInUp');
            }
        });
    });
    
    document.querySelectorAll('.card').forEach(card => {
        observer.observe(card);
    });
});
</script>
<script src="/static/js/flags.js"></script>
<script>
// Hero latest coins rotator (emoji flags)
document.addEventListener('DOMContentLoaded', function() {
    const coins = {{ latest_coins | default([]) | tojson }};
    if (!coins || coins.length === 0) return;
    let idx = 0;
    const countryEl = document.getElementById('hero-country');
    const valueEl = document.getElementById('hero-value');
    const flagEl = document.getElementById('hero-country-flag');
    const cardEl = document.getElementById('hero-latest-coin');
    const imgEl = document.getElementById('hero-coin-img');
    const typeYearEl = document.getElementById('hero-type-year');
    const dotsContainer = document.getElementById('hero-dots');

    // Minimal styles for dots (kept here to avoid editing CSS files)
    const style = document.createElement('style');
    style.innerHTML = `
    .hero-dot { display:inline-block; width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,0.4); cursor:pointer; }
    .hero-dot.active { background: #ffffff; box-shadow: 0 0 6px rgba(0,0,0,0.2); }
    .hero-dot.edge-dot { width:20px; border-radius:6px; }
    `;
    document.head.appendChild(style);

    // Map four dots to [first, prev, next, last]
    function visibleIndexes(i) {
        const first = 0;
        const prev = Math.max(0, i - 1);
        const next = Math.min(coins.length - 1, i + 1);
        const last = Math.max(0, coins.length - 1);
        return [first, prev, next, last];
    }

    function updateDots(i) {
        const vis = visibleIndexes(i);
        // Ensure 4 dot elements exist
        const dots = Array.from(dotsContainer.querySelectorAll('.hero-dot'));
        // first clear active on all
        for (let d = 0; d < 4; d++) {
            const dot = dots[d];
            if (!dot) continue;
            dot.dataset.index = String(vis[d]);
            dot.classList.remove('active');
            if (d === 0 || d === 3) {
                dot.classList.add('edge-dot');
            } else {
                dot.classList.remove('edge-dot');
            }
        }

        // Activate based on position: first -> dot0, last -> dot3, otherwise -> prev (dot1)
        const first = 0;
        const last = Math.max(0, coins.length - 1);
        if (i === first) {
            if (dots[0]) dots[0].classList.add('active');
        } else if (i === last) {
            if (dots[3]) dots[3].classList.add('active');
        } else {
            if (dots[1]) dots[1].classList.add('active');
        }
    }

    function setCoin(c, skipAnimation) {
        const flag = (typeof window !== 'undefined' && typeof window.getCountryFlag === 'function')
            ? window.getCountryFlag(c.country)
            : 'ðŸ‡ªðŸ‡º';

        flagEl.textContent = flag;
        countryEl.textContent = c.country || '';
        valueEl.textContent = c.value ? `â‚¬${parseFloat(c.value).toFixed(2)}` : '';
        imgEl.src = c.image || c.image_url || '/static/images/coin-placeholder.png';
        imgEl.alt = `${c.country || ''} coin`;
        const typeLabel = c.coin_type === 'RE' ? 'Regular' : (c.coin_type === 'CC' ? 'Commemorative' : c.coin_type || '');
        let typeYearText = '';
        if (typeLabel && c.year) {
            typeYearText = `${typeLabel} \u2022 ${c.year}`;
        } else if (typeLabel) {
            typeYearText = typeLabel;
        } else if (c.year) {
            typeYearText = `${c.year}`;
        }
        typeYearEl.textContent = typeYearText;

        // Small 3D highlight animation
        if (!skipAnimation) {
            cardEl.classList.remove('hero-card-pop');
            void cardEl.offsetWidth; // force reflow
            cardEl.classList.add('hero-card-pop');
        }

        updateDots(idx);
    }

    // Initial render and dots wiring
    setCoin(coins[idx], true);
    updateDots(idx);

    // Dot click -> jump to the corresponding coin (first, prev, next, last)
    dotsContainer.querySelectorAll('.hero-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            const targetIndex = parseInt(this.dataset.index || '0', 10);
            if (!Number.isNaN(targetIndex)) {
                idx = Math.max(0, Math.min(coins.length - 1, targetIndex));
                setCoin(coins[idx]);
                if (idx < coins.length - 1) {
                    resetAutoRotate();
                } else {
                    stopAutoRotate();
                }
            }
        });
    });

    // Auto rotate (reasonable interval)
    let rotateInterval = 4500; // 4.5s
    let rotateTimer = null;

    function startAutoRotate() {
        stopAutoRotate();
        // Only auto-rotate if there are at least 2 coins and we're not at last
        if (coins.length < 2 || idx >= coins.length - 1) return;
        rotateTimer = setInterval(() => {
            if (idx < coins.length - 1) {
                idx = idx + 1;
                setCoin(coins[idx]);
            } else {
                // stop at the last coin (no wrap-around)
                stopAutoRotate();
            }
        }, rotateInterval);
    }

    function stopAutoRotate() {
        if (rotateTimer) {
            clearInterval(rotateTimer);
            rotateTimer = null;
        }
    }

    function resetAutoRotate() {
        stopAutoRotate();
        // Restart after a brief pause, but only if not at last coin
        if (idx < coins.length - 1) {
            setTimeout(startAutoRotate, 1200);
        }
    }

    startAutoRotate();

    // Swipe / drag support (touch + mouse)
    let touchStartX = null;
    let isPointerDown = false;

    function onPointerStart(x) {
        touchStartX = x;
        isPointerDown = true;
        stopAutoRotate();
    }

    function onPointerEnd(x) {
        if (!isPointerDown || touchStartX === null) return;
        const dx = x - touchStartX;
        const threshold = 40; // px
        if (dx > threshold) {
            // swipe right -> previous, only if not at first
            if (idx > 0) {
                idx = idx - 1;
                setCoin(coins[idx]);
            }
            resetAutoRotate();
        } else if (dx < -threshold) {
            // swipe left -> next, only if not at last
            if (idx < coins.length - 1) {
                idx = idx + 1;
                setCoin(coins[idx]);
            }
            resetAutoRotate();
        } else {
            // small move - treat as a tap, do nothing
            resetAutoRotate();
        }

        touchStartX = null;
        isPointerDown = false;
    }

    // Touch events
    cardEl.addEventListener('touchstart', function(e) {
        const t = e.touches[0];
        onPointerStart(t.clientX);
    }, {passive: true});

    cardEl.addEventListener('touchend', function(e) {
        // touchend has no touches; use changedTouches
        const t = e.changedTouches[0];
        onPointerEnd(t.clientX);
    });

    // Mouse drag support
    cardEl.addEventListener('mousedown', function(e) {
        onPointerStart(e.clientX);
    });
    document.addEventListener('mouseup', function(e) {
        // only end if pointer was down
        if (isPointerDown) onPointerEnd(e.clientX);
    });
    // Prevent image drag ghost
    imgEl.addEventListener('dragstart', function(e){ e.preventDefault(); });

    // Also support clicking the card to advance
    cardEl.addEventListener('click', function(e) {
        // avoid treating drag as click
        if (isPointerDown) return;
        // advance only if not at last coin (no wrap-around)
        if (idx < coins.length - 1) {
            idx = idx + 1;
            setCoin(coins[idx]);
            resetAutoRotate();
        }
    });
});
</script>
{% endblock %}
